
<table id='tabLista'><!-- linhas -->
<form name='formLista' id='formLista' method='post' action='<?= $base.strtolower($module).'/'.strtolower($controller).'/salvar' ?>' >
<input type='hidden' name='urlRetorno' value='<?= $this->viewVars['urlRetorno'] ?>' style='width: 300px;' />
<input type='hidden' name='marcador' value='' id='marcador' style='width: 300px;' />
<?php foreach($this->data as $_l => $_arrMods) : ?>

<?php if (!$_l) : ?>
<tr><!-- cabeçalho das linhas -->
	<th>
	<input type='checkbox' name='cxAll' id='cxAll' title='clique aqui para selecionar todos'
		<?php
		array_push($this->viewVars['onRead'], '$("#cxAll").click(function(event) 
		{
			if (this.checked==true)
				$(".cxLista").each(function() { this.checked = true; });
			else
				$(".cxLista").each(function() { this.checked = false; });
		})');
	?>
	/>
	</th>
	<th style='text-align: center;' colspan='<?= count($ferramentas); ?>'>#
	</th>

	<?php
	foreach($this->viewVars['fields'] as $_l2 => $_cmp) : 
	$c = $_cmp;
	$a = explode('.',$_cmp); 
	$d = ($this->viewVars['params']['dir']=='asc') ? 'desc' : 'asc';
	$p = $this->viewVars['esquema'][$a['0']][$a['1']];
	$i = isset($this->viewVars['esquema'][$a['0']][$a['1']]['key']) ? true : false; // é indice
	$t = $p['tit'];
	if (isset($p['belongsTo']))
	{
		$c = $this->Html->getFieldRel($p['belongsTo']);
	}

	$l = $base.strtolower($module.'/'.$controller.'/lista/pag:'
		.$this->viewVars['params']['pag'].'/ord:'.str_replace('.', '_', $c).'/dir:'.$d);
	?>
	<th class="th<?= $this->Html->domId($a['1']) ?>">
		<?php if ($i) : ?>
		<a href='<?= $l ?>'><?= $t ?></a>
		<?php else : ?>
		<?= $t ?>
		<?php endif ?>
	</th>
	<?php endforeach ?>
</tr>
<?php endif ?>

<?php if (isset($erros[$_l])) : ?>
<tr>
	<td colspan='100' class='td_lista_erro'>
		<?= $erros[$_l] ?>
	</td>
</tr>
<?php endif ?>

<tr><!-- linha a linha -->
	<td>
		<?php
			$ids = '';
			foreach($this->viewVars['primaryKey'] as $_l3 => $_cmp3) 
			{
				if ($_l3) $ids .= ',';
				$ids .= $_cmp3.'='.$_arrMods[$this->viewVars['modelClass']][$_cmp3];
			}
		?>
		<input type='checkbox' class='cxLista' name='cx[<?= $ids ?>]' id='cx<?= ($_l+1) ?>' />
	</td>

	<?php // loop nas ferramentas de cada linha
	foreach($this->viewVars['ferramentas'] as $_fer => $_prop) : 
		$_prop['title'] = isset($_prop['title']) ? $_prop['title'] : $_fer;
		$arqBt 			= 'bt_'.$_fer.'.png';
		if (strpos($_prop['link'], '*')) // substituindo o campo pelo valor do campo
		{
			foreach($this->viewVars['primaryKey'] as $_l2 => $_cmp)
			{ 
				$v = $_arrMods[$this->viewVars['modelClass']][$_cmp];
				$_prop['link'] = str_replace('*'.$_cmp.'*', $v, $_prop['link']);
			}
		}
		?>
		<td>
			<a href='<?= $_prop['link'] ?>' 
			<?php if (isset($_prop['onclick'])) : ?>
				onclick="<?= $_prop['onclick'] ?>"
			<?php endif; ?>
			>
				<img src='<?= $base ?>img/<?= $arqBt ?>' title='<?= $_prop['title'] ?>' /> 
			</a>
		</td>
	<?php endforeach ?>

	<?php  // loop nos campos para escrever a coluna de cada linha
		foreach($this->viewVars['primaryKey'] as $_l3 => $_cmp3) // campos primários
		{
			echo "<input type='hidden' value='".$_arrMods[$a['0']][$_cmp3]
				."' name='data[".($_l+1)."][".$this->viewVars['modelClass']."][".$_cmp3."]' />";
		}
		foreach($this->viewVars['fields'] as $_l2 => $_cmp) : 
			$a = explode('.',$_cmp);
			$p = $this->viewVars['esquema'][$a['0']][$a['1']];
			$cmp = ($_l+1).'.'.$a['0'].'.'.$a['1'];
			$p['value'] = $_arrMods[$a['0']][$a['1']];
	?>
		<td align='center' id='td<?= $this->Html->domId(($_l+1).'.'.$a['1']) ?>' class="td<?= $this->Html->domId($a['1']) ?>">
			<?php
				echo $this->Html->getInput($cmp,$p,$this->data[$_l]);
				if (isset($p['mascara']))
				{
					array_push($this->viewVars['onRead'],'$("#'.$this->Html->domId($cmp).'").mask("'.str_replace('#','9',$p['mascara']).'")');
				}
			?>
		</td>
	<?php endforeach ?>
</tr>

<?php endforeach ?>
</form>
</table><!-- fim linhas -->
<div style='margin: 0px 0px 0px 12px; font-size: 14px;'>
	Total de registros: <?= number_format($this->viewVars['paginacao']['tot'],0,',','.'); ?>
</div>
